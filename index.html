<html>
<head>
<title> Simple JS Koch curve implementation </title>
</head>
<body>
<canvas id='canvas', width='1920', height='1280'>
	HTML5 is not supported!
</canvas>
<script>

	var getNormalCoeff = function(k0, invert)
	{
		var k1 = -1 / k0;
		var k1_angle = Math.atan(k1);
		if (invert)
		{
			k1_angle = k1_angle - Math.PI;
			k1 = Math.tan(k1_angle);
		}
		return [k1, k1_angle];
	}

	var computeNormal = function(k0, k1_angle, L, one_third, x0, y0)
	{

		var fromX = x0 + one_third + 0.5 * one_third;
		var b = -k0 * x0 + y0;
		var fromY = k0 * fromX + b;
		
		var toX = L * Math.cos(k1_angle);
		var toY = L * Math.sin(k1_angle);

		return [fromX, fromY, toX, toY, b];
	}

	var getTangentCoeff = function(x0, y0, x1, y1)
	{
		return (y1 - y0) / (x1 - x0);
	}

	var getL = function(x0, y0, x1, y1)
	{
		var x_sq = (x1 - x0) * (x1 - x0);
		var y_sq = (y1 - y0) * (y1 - y0);
		return (Math.sqrt(x_sq + y_sq)) / 3;
	}

	var rayLineIntersection = function(ax, ay, bx, by, adx, ady, bdx, bdy)
	{
		// ray-line intersection test (stX = a, x0 = b)
		var dx = bx - ax;
		var dy = by - ay;
		var det = bdx * ady - bdy * adx;
		var u = (dy * bdx - dx * bdy) / det;
		var v = (dy * adx - dx * ady) / det;
		return (v > 0 && det != 0)	
	}

	var drawKochLine = function(old_n, stX, stY, endX, endY, steps, context)
	{

		if (steps <= 0) return;

		var k0 = getTangentCoeff(stX, stY, endX, endY);
		var res = getNormalCoeff(k0, false);

		var k1 = res[0], k1_angle = res[1];

		var one_third = (endX - stX) / 3;
		var half_third = 0.5 * (endX - stX) / 3;
		var L = getL(stX, stY, endX, endY);

		context.beginPath();
		context.moveTo(stX, stY);
		context.lineTo(endX, endY);
		context.strokeStyle = '#000000';
		context.lineWidth = 1;
		context.stroke();

		if (steps > 1)
		{
			context.beginPath();
			context.moveTo(stX + one_third, stY + one_third * (endY - stY) / (endX - stX));
			context.lineTo(stX + 2 * one_third, stY + 2 * one_third * (endY - stY) / (endX - stX));		
			context.strokeStyle = 'white';
			context.lineWidth = 3;
			context.stroke();
		}

		var res = computeNormal(k0, k1_angle, L, one_third, stX, stY);

		var x0 = res[0], 
			y0 = res[1], 
			newX = res[2], 
			newY = res[3], 
			b = res[4];

		if (old_n != NaN)
		{
			
			if (rayLineIntersection(old_n[2], old_n[3], x0, y0, old_n[0], old_n[1], newX, newY))
			{			
				k1_angle = k1_angle - Math.PI;
				k1 = Math.tan(k1_angle);
			}
			
			res = computeNormal(k0, k1_angle, L, one_third, stX, stY);
			x0 = res[0], y0 = res[1], newX = res[2], newY = res[3], b = res[4];

		}

		if (steps == STEPS)
		{
			drawKochLine([endX, stY, 0, stY], stX, stY, stX + one_third, stY, steps - 1, context);
			drawKochLine([endX, stY, 0, stY], stX + 2 * one_third, stY, endX, stY, steps - 1, context);
		}

		drawKochLine([newX, newY, x0, y0], x0 - 0.5 * one_third, k0 * (x0 - 0.5 * one_third) + b, x0 + newX, y0 + newY, steps - 1, context);
		drawKochLine([newX, newY, x0, y0], x0 + 0.5 * one_third, k0 * (x0 + 0.5 * one_third) + b, x0 + newX, y0 + newY, steps - 1, context);

		if (steps != STEPS)
		{			
			drawKochLine(old_n, x0 - 0.5 * one_third, k0 * (x0 - 0.5 * one_third) + b, x0 - 0.5 * one_third - one_third, k0 * (x0 - 0.5 * one_third - one_third) + b, steps - 1, context);

			drawKochLine(old_n, x0 + 0.5 * one_third, k0 * (x0 + 0.5 * one_third) + b, x0 + 0.5 * one_third + one_third, k0 * (x0 + 0.5 * one_third + one_third) + b, steps - 1, context);
		}

		// draw a normal, debug only
		
		context.beginPath(); 
		context.moveTo(x0, y0);
		//console.log(x0, y0, newX, newY);
		context.lineTo(x0 + newX, y0 + newY);
		context.strokeStyle = '#ff0000';
		context.stroke();
		
	}

	var canvas = document.getElementById('canvas');
	var context = canvas.getContext('2d');

	var stX = 10, stY = 800, endX = 1920, endY = 800, STEPS = 7;

	drawKochLine(NaN, stX, stY, endX, endY, STEPS, context);

</script>
</body>
</html>