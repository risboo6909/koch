<html>
<head>
<title> Simple JS Koch curve implementation </title>
</head>
<body>
<canvas id='canvas', width='1920', height='1280'>
	HTML5 is not supported!
</canvas>

<script src='http://yandex.st/bootstrap/3.0.2/js/bootstrap.min.js'></script>

<script>

	var getNormalCoeff = function(k0, invert)
	{
		var k1 = -1 / k0;
		var k1_angle = Math.atan(k1);
		if (invert)
		{
			k1_angle = k1_angle - Math.PI;
			k1 = Math.tan(k1_angle);
		}
		return [k1, k1_angle];
	}

	var computeNormal = function(k, k1_angle, L, one_third, x, y)
	{

		var b = -k * x + y;
		var x0 = x + 1.5 * one_third;
		var y0 = k * x0 + b;

		return [x0, y0, L * Math.cos(k1_angle), L * Math.sin(k1_angle), b];
	}

	var getL = function(x0, y0, x1, y1)
	{
		var x_sq = (x1 - x0) * (x1 - x0);
		var y_sq = (y1 - y0) * (y1 - y0);
		return (Math.sqrt(x_sq + y_sq)) / 3;
	}

	var rayLineIntersection = function(ax, ay, bx, by, adx, ady, bdx, bdy)
	{
		// ray-line intersection test (stX = a, x0 = b)
		var dx = bx - ax;
		var dy = by - ay;
		var det = bdx * ady - bdy * adx;
		var u = (dy * bdx - dx * bdy) / det;
		var v = (dy * adx - dx * ady) / det;
		return (v > 0 && det != 0)	
	}

	var drawLine = function(context, fromX, fromY, toX, toY, color, width)
	{
		context.beginPath();
		context.moveTo(fromX, fromY);
		context.lineTo(toX, toY);
		context.strokeStyle = color;
		context.lineWidth = width;
		context.stroke();
	}

	var drawKochSegment = function(old_n, stX, stY, endX, endY, steps, context)
	{

		if (steps <= 0) 
			return;

		var one_third = (endX - stX) / 3, half_third = 0.5 * one_third;

		var L = getL(stX, stY, endX, endY);

		var k0 = (endY - stY) / (endX - stX);

		var res = getNormalCoeff(k0, false);
		var k1 = res[0], k1_angle = res[1];

		drawLine(context, stX, stY, endX, endY, '#000000', 1);
		
		if (steps > 1)
			drawLine(context, stX + one_third, stY + one_third * k0, stX + 2 * one_third, stY + 2 * one_third * k0, 'white', 3);			

		var res = computeNormal(k0, k1_angle, L, one_third, stX, stY);

		var x0 = res[0], 
			y0 = res[1], 
			newX = res[2], 
			newY = res[3], 
			b = res[4];

		if (old_n != NaN)
		{
			
			if (rayLineIntersection(old_n[2], old_n[3], x0, y0, old_n[0], old_n[1], newX, newY))
			{			
				k1_angle = k1_angle - Math.PI;
				k1 = Math.tan(k1_angle);
			}
			
			res = computeNormal(k0, k1_angle, L, one_third, stX, stY);
			x0 = res[0], y0 = res[1], newX = res[2], newY = res[3], b = res[4];

		}

		if (steps == STEPS)
		{
			var k = (endY - stY) / 3;
			drawKochSegment([endX, stY, 0, stY], stX, stY, stX + one_third, stY + k, steps - 1, context);
			drawKochSegment([endX, stY, 0, stY], stX + 2 * one_third, stY + 2 * k, endX, stY + 3 * k, steps - 1, context);
		}
			else
		{			
			drawKochSegment(old_n, x0 - half_third, k0 * (x0 - half_third) + b, x0 - 1.5 * one_third, k0 * (x0 - 1.5 * one_third) + b, steps - 1, context);
			drawKochSegment(old_n, x0 + half_third, k0 * (x0 + half_third) + b, x0 + 1.5 * one_third, k0 * (x0 + 1.5 * one_third) + b, steps - 1, context);
		}

		drawKochSegment([newX, newY, x0, y0], x0 - half_third, k0 * (x0 - half_third) + b, x0 + newX, y0 + newY, steps - 1, context);
		drawKochSegment([newX, newY, x0, y0], x0 + half_third, k0 * (x0 + half_third) + b, x0 + newX, y0 + newY, steps - 1, context);

		// draw a normal, debug only
		drawLine(context, x0, y0, x0 + newX, y0 + newY, '#FF0000', 1);
		
	}

	var canvas = document.getElementById('canvas');
	var context = canvas.getContext('2d');

	var STEPS = 6;

	drawKochSegment(NaN, 10, 800, 1920, 800, STEPS, context);

</script>
</body>
</html>