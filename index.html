<html>
<head>
<title> Simple JS Koch snowflake implementation </title>
</head>
<body>
<canvas id='canvas', width='1920', height='1280'>
	HTML5 is not supported!
</canvas>
<script>

	var getNormalCoeff = function(k0, invert)
	{
		var k1 = -1 / k0;
		var k1_angle = Math.atan(k1);
		if (invert)
		{
			k1_angle = k1_angle - Math.PI;
			k1 = Math.tan(k1_angle);
		}
		return [k1, k1_angle];
	}

	var computeNormal = function(k0, k1_angle, L, third, x0, y0)
	{

		var fromX = x0 + third + 0.5 * third;
		var b = -k0 * x0 + y0;
		var fromY = k0 * fromX + b;
		
		var toX = L * Math.cos(k1_angle);
		var toY = L * Math.sin(k1_angle);

		return [fromX, fromY, toX, toY, b];
	}

	var getTangentCoeff = function(x0, y0, x1, y1)
	{
		return (y1 - y0) / (x1 - x0);
	}

	var getLength = function(x0, y0, x1, y1)
	{
		var x_sq = (x1 - x0) * (x1 - x0);
		var y_sq = (y1 - y0) * (y1 - y0);
		return (Math.sqrt(x_sq + y_sq)) / 3;
	}

	var rayRayIntersection = function(ax, ay, bx, by, adx, ady, bdx, bdy)
	{
		// ray-ray intersection test (stX = a, x0 = b)
		var dx = bx - ax;
		var dy = by - ay;
		var det = bdx * ady - bdy * adx;
		var u = (dy * bdx - dx * bdy) / det;
		var v = (dy * adx - dx * ady) / det;

		return (u > 0 && v > 0 && det != 0)
	}

	var drawKochLine = function(old_n, stX, stY, endX, endY, steps, context)
	{

		if (steps <= 0) return;

		var k0 = getTangentCoeff(stX, stY, endX, endY);
		var res = getNormalCoeff(k0, false);

		var k1 = res[0], k1_angle = res[1];

		var third = (endX - stX) / 3;
		var length = getLength(stX, stY, endX, endY);

/*
		// compute an endpoint
		context.beginPath();
		context.moveTo(stX, stY);
		context.lineTo(stX + third, stY + third * (endY - stY) / (endX - stX));
		context.strokeStyle = '#000000';
		context.stroke();

		context.beginPath();
		context.moveTo(endX, endY);
		context.lineTo(endX - third, endY - third * (endY - stY) / (endX - stX));
		context.strokeStyle = '#000000';
		context.stroke();

*/
		context.beginPath();
		context.moveTo(stX, stY);
		context.lineTo(endX, endY);
		context.strokeStyle = '#000000';
		context.stroke();

		var res = computeNormal(k0, k1_angle, length, third, stX, stY);

		var x0 = res[0], 
			y0 = res[1], 
			newX = res[2], 
			newY = res[3], 
			b = res[4];

		if (old_n != NaN)
		{

			//rayRayIntersection();

			var n = [newX, newY];//normalize(n[0], n[1]);
			//var old_n = [endX - stX, endY - stY]; //normalize(old_n[0], old_n[1]);
			
			// ray-ray intersection, stX = a , x0 = b
			/*
			var dx = x0 - old_n[2];
			var dy = y0 - old_n[3];
			var det = n[0] * old_n[1] - n[1] * old_n[0];
			var u = (dy * n[0] - dx * n[1]) / det;
			var v = (dy * old_n[0] - dx * old_n[1]) / det;
			*/

			//console.log('iter ' + det);
			//console.log(u, v);
			//if (u > 0 && v > 0 && det != 0)
			if (rayRayIntersection(old_n[2], old_n[3], x0, y0, old_n[0], old_n[1], n[0], n[1]))
			{
			//	console.log('intersection');
				k1_angle = k1_angle - Math.PI;
				k1 = Math.tan(k1_angle);

			}
			
			res = computeNormal(k0, k1_angle, length, third, stX, stY);
			x0 = res[0], y0 = res[1], newX = res[2], newY = res[3], b = res[4];

		}

		drawKochLine([newX, newY, x0, y0], x0 - 0.5 * third, k0 * (x0 - 0.5 * third) + b, x0 + newX, y0 + newY, steps - 1, context);
		drawKochLine([newX, newY, x0, y0], x0 + 0.5 * third, k0 * (x0 + 0.5 * third) + b, x0 + newX, y0 + newY, steps - 1, context);

		// draw a normal, debug only
		/*
		context.beginPath(); 
		context.moveTo(x0, y0);
		//console.log(x0, y0, newX, newY);
		context.lineTo(x0 + newX, y0 + newY);
		context.strokeStyle = '#ff0000';
		context.stroke();
		*/
	}

	var canvas = document.getElementById('canvas');
	var context = canvas.getContext('2d');

	drawKochLine(NaN, 10, 650, 1920, 650, 9, context);
	//drawKochLine(NaN, 10, 650, 1920, 649, 9, context);

</script>
</body>
</html>